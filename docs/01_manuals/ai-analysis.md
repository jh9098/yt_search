# ai-analysis.md

## 목적
이 문서는 "AI 소재 분석" 기능의 프롬프트 원칙, 출력 스키마, 검증/보정 규칙,
사실 요약 vs AI 제안 구분, 실패 처리 정책을 정의합니다.

이 기능은 서비스의 핵심 가치이므로, 자유로운 텍스트 생성보다 **구조화된 결과**를 우선합니다.

---

## 핵심 원칙
1. **출력은 반드시 JSON 스키마를 따른다**
2. **사실 요약과 AI 제안을 분리한다**
3. **근거 없는 단정 표현을 줄인다**
4. **결측값/실패 케이스를 허용 가능한 구조로 반환한다**
5. **분석 메타데이터(모델/기준 데이터 수/시각)를 함께 저장한다**

---

## 분석 입력 데이터 (예시)
AI 분석에 사용 가능한 입력은 다음과 같습니다.

### 필수(초기)
- 영상 제목
- 채널명 (가능하면)
- 영상 설명 (가능하면)
- 조회수/업로드일/길이 등 기본 메타 (가능하면)
- 댓글 텍스트 샘플 (가능한 범위)

### 선택(추후)
- 자막/스크립트
- 댓글 좋아요 수
- 댓글 언어 감지 결과
- 채널 카테고리
- 썸네일 텍스트 OCR 결과

---

## 결과 구조의 개념 구분 (중요)
### A. 사실 기반 요약 (Evidence-like summary)
입력 데이터(댓글/제목/설명)에서 반복적으로 관찰되는 패턴 요약

예:
- 주요 반응
- 긍정 포인트
- 아쉬운 점
- 반복 키워드

### B. AI 제안 (Generated suggestions)
분석 결과를 바탕으로 AI가 제안하는 후속 아이디어/기획 방향

예:
- 후속 소재 추천
- 제목 훅 방향
- 대본 전개 제안
- 타겟별 변형 아이디어

UI/문서에서 두 범주를 혼동하지 않게 라벨링 권장:
- "요약"
- "AI 제안"

---

## 출력 스키마 원칙
세부 스키마는 `docs/03_prompts/output-schema-analysis.json` 및 `api-contracts.md`를 기준으로 관리합니다.

최소 필드(초기 MVP 권장):
- `summary.majorReactions`
- `summary.positivePoints`
- `summary.weakPoints`
- `contentIdeas[]` (제목 + 설명)
- `recommendedKeywords[]`
- `meta` (모델명/분석시각/기준 데이터 수 등)

### 필드 설계 원칙
- 누락 가능성이 높은 필드는 nullable 또는 기본값 정책 문서화
- 배열 필드는 빈 배열 허용 (`[]`)
- 문자열 필드는 빈 문자열보다 의미 있는 fallback 문구를 선호
- 스키마 버전 필드 포함 권장 (`schemaVersion`, `analysisVersion`)

---

## 프롬프트 작성 원칙 (Gemini)
### 시스템 프롬프트 방향
- 역할: "댓글 및 영상 메타 기반 콘텐츠 전략 분석가"
- 출력 형식: JSON only
- 금지: 설명문, 코드블록, 인사말, 머리말
- 요구: 사실 요약 vs AI 제안 구분

### 사용자 프롬프트 방향
입력 데이터와 함께 다음을 명확히 전달:
- 분석 목표 (소재 발굴용)
- 대상 분야/채널 톤(가능하면)
- 출력 JSON 스키마
- 길이 제한(과도한 장문 방지)
- 추정/의견은 제안으로 분류할 것

---

## 출력 검증 규칙 (매우 중요)
Gemini 응답은 항상 아래 **고정 순서**로 처리합니다.

1. **JSON 파싱**
2. **스키마 검증(1차)**
3. **필드 보정(허용 범위 내)**
4. **스키마 재검증(2차)**
5. **저장 또는 실패 처리**

### 검증 대상 예시
- 필수 키 존재 여부
- `contentIdeas`가 배열인지
- `recommendedKeywords`가 문자열 배열인지
- `meta` 필드 형식
- 문자열 길이 제한(과도한 출력 방지)

### D-5 정책 확정: 누락 허용/기본값 적용 표 (고정)
| 필드 | 누락 허용 여부 | 기본값/보정 규칙 | 보정 후 상태 |
|---|---|---|---|
| `summary.majorReactions` | 불가 | 없음 | 누락 시 `failed` |
| `summary.positivePoints` | 불가 | 없음 | 누락 시 `failed` |
| `summary.weakPoints` | 허용 | `"충분한 데이터가 없어 아쉬운 점을 특정하기 어렵습니다."` | `partial-success` |
| `contentIdeas` | 허용 | `[]` + `meta.warnings`에 누락 보정 사유 추가 | `partial-success` |
| `recommendedKeywords` | 허용 | `[]` | `partial-success` |
| `meta.model` | 불가 | 없음 | 누락 시 `failed` |
| `meta.analyzedAt` | 불가 | 없음 | 누락 시 `failed` |
| `meta.analysisBasis` | 불가 | 없음 | 누락 시 `failed` |
| `meta.analysisVersion` | 불가 | 없음 | 누락 시 `failed` |
| `meta.schemaVersion` | 불가 | 없음 | 누락 시 `failed` |
| `meta.warnings` | 허용 | 없으면 `[]`로 초기화 | `completed` 유지 |

주의:
- 보정은 위 표 범위 내에서만 허용합니다.
- 임의 보정으로 의미 왜곡 금지합니다.
- 보정이 1개 이상 발생하면 `meta.warnings`에 보정 내역을 기록합니다.

---

## 실패 처리 정책
### 실패 유형 예시
- 댓글 데이터 없음
- Gemini timeout
- Gemini 응답 형식 오류(JSON 파싱 실패)
- 스키마 검증 실패(필수 필드 누락/타입 불일치)
- 저장 실패

### D-5 정책 확정: `failed` vs `partial-success` 분기 기준 (고정)
| 상황 | 처리 결과 | 상태값 | 사용자 안내 |
|---|---|---|---|
| JSON 파싱 자체 실패 | 전체 실패 | `failed` | 재시도 안내 |
| 1차 스키마 검증에서 필수 필드 누락(보정 불가) | 전체 실패 | `failed` | 재시도 안내 |
| 허용 필드 누락 + 보정 가능 | 부분 성공 | `completed` + 프론트 `partial-success` | 누락/보정 안내 문구 표시 |
| 2차 재검증 실패 | 전체 실패 | `failed` | 재시도 안내 |
| 저장 단계 실패 | 전체 실패 | `failed` | 재시도 안내 |

### 사용자 응답 정책
- 사용자에게는 간결하고 재시도 가능한 메시지 제공
- 내부 로그에는 상세 실패 원인 기록
- 부분 성공 시 "사용 가능한 결과 우선 표시 + 누락 데이터 안내"를 기본값으로 사용

### 저장 전 처리 체크리스트 (고정)
- [ ] JSON 파싱 성공 여부 확인
- [ ] 1차 스키마 검증 결과 기록
- [ ] 허용 필드 보정 적용 + `meta.warnings` 누적
- [ ] 2차 스키마 재검증 성공 확인
- [ ] 저장 후 `status`/`meta`/경고 문구 정합성 확인

---

## 분석 메타데이터 저장/표시 규칙
최소 메타데이터 권장 필드:
- `model`
- `analyzedAt`
- `commentSampleCount`
- `analysisBasis` (예: title/description/comments)
- `languageSummary` (선택)
- `cacheHit` (선택)
- `analysisVersion`
- `schemaVersion`

이 정보는 사용자 신뢰와 디버깅에 중요함

---

## 민감/주의 도메인 문구 정책
건강/심리/금융/투자 관련 분석은 과도한 단정 문구를 피합니다.

권장:
- "~로 보입니다"
- "~반응이 관찰됩니다"
- "AI 제안 관점에서"
- "추가 검토 필요"

비권장:
- "반드시"
- "정답"
- "확실히 이게 원인"
- 근거 없이 진단/판단처럼 보이는 표현

---

## 추천 키워드 생성 규칙 (초기)
- 너무 일반적인 단어만 나열하지 않기
- 재검색 가능한 수준의 구체성 유지
- 해시태그 형식 여부는 UI 정책에 따름 (`#가족관계`)
- 최대 개수 제한 권장 (예: 5~8개)

---

## 변경 시 문서 동기화 규칙
다음이 바뀌면 반드시 동기화:
- 출력 필드 변경 → `api-contracts.md` + `output-schema-analysis.json`
- 보정 규칙 변경 → 이 문서 + `CONTEXT_NOTE.md`
- meta 필드 변경 → 프론트 타입 + 백엔드 스키마 + `api-contracts.md`

---

## 완료 보고 필수 항목 (AI 분석 작업)
- 프롬프트 변경 여부
- 출력 스키마 변경 여부
- 검증/보정 규칙 변경 여부
- 실패 처리 정책 변경 여부
- 샘플 입력/출력 검증 결과
